import React, { useEffect, useState, createContext } from "react";
import {
  CategoryTitle,
  EditCategory,
  MenuCategoriesDiv,
  Icon,
  MenuTitleName,
  MenuCategoryMainDIv,
} from "./MenuCategories.style";
import { useSubCategoryIdStore } from "../../../Pages/states/MenuCategory.state";
import { MenuCategoriesTypes } from "../../../Types/Components/MenuCategoriesTypes";
import { useNavigate, useParams } from "react-router-dom";
import ActionButton from "../../ActionButton/ActionButton";
import { MdAdd } from "react-icons/md";
import { HTTPMethods } from "../../../Utils/HTTPMock";
import { toast } from "react-toastify";
import AlertDeleteModal from "../../Modals/PopUpModal/AlertDeleteModal";
import { useFormik } from "formik";
import * as yup from "yup";
import AddNewMenuModal from "../../Modals/AddNewMenuModal/AddNewMenuModal";
import { TextField } from "../../TextField";
import { Button } from "../../TextField.Style";
type RouteParamType = {
  id: any;
};
export const MyCategoryIdContext = createContext<any>(null);
const MenuCategories = (props: MenuCategoriesTypes) => {
  //
  let schema = yup.object().shape({
    category_name: yup.string().required("is required"),
    category_image: yup.mixed().required("is required"),
  });

  const {
    values,
    errors,
    handleChange,
    handleSubmit,
    handleReset,
    resetForm,
    touched,
  } = useFormik({
    initialValues: {
      category_name: "",
      image: "",
    },
    onSubmit: async (values, action) => {
      console.log(values);
      
      HTTPMethods.postMenu("/category/addcategory", values)
        .then(async (res) => {
          action.resetForm();
          console.log(res);
          toast.success("Product added successfully", {
            theme: "colored",
            hideProgressBar: true,
            autoClose: 1000,
          });
          action.resetForm();
        })
        .catch((err) => {
          toast.success("Product added successfully", {
            theme: "colored",
            hideProgressBar: true,
            autoClose: 1000,
          });
        });
    },
    validationSchema: schema,
  });

  // image------{start
  // image to base64 converter
  const [file, setFile] = useState<File | any>();
  function convetToBase64(filetarget: File) {
    return new Promise((resolve: any, reject: any) => {
      const fileReader = new FileReader();
      fileReader.readAsDataURL(filetarget);
      fileReader.onload = () => {
        resolve(fileReader.result);
      };
      fileReader.onerror = (error) => {
        reject(error);
      };
    });
  }
  //base64 image handler
  const onUpload = async (e: any) => {
    const filetarget = e.target.files[0];
    console.log(filetarget);
    const base64 = await convetToBase64(filetarget);
    setFile(base64);
    console.log(file);
    alert(file);
  };
  //image-------- end}

  //
  const { title, deleteIcon, editIcon, clicked, categoryList, ...rest } = props;
  const { drawerSubCatId, setDrawerSubCatId } = useSubCategoryIdStore();
  const [category, setCategory] = useState(categoryList);
  const [hoveredIndex, setHoveredIndex] = useState<null | number>(null);

  // modal states -----{start
  const [openModal, setOpenModal] = useState(false);
  const [deleteItem, setDeleteItem] = useState(false);
  const [addMenuModal, setAddMenuModal] = useState(false);
  const [deleteCategoryId, setDeleteCategoryId] = useState<string>("");
  const [modalTitle, setModalTitle] = useState<string>();
  //modal states -----end}

  const navigate = useNavigate();
  const { id } = useParams<RouteParamType>();
  const handleEdit = () => {};

  // const handleChange = () => {
  //   alert("change");
  // };

  // delete category
  function handleDelete(subCatId: any) {
    HTTPMethods.deleteMenu(`/category/deletecategory/`, {})
      .then(async (res) => {
        toast.success("Category deleted Successfully.", {
          theme: "colored",
          hideProgressBar: true,
          autoClose: 1500,
          position: "bottom-right",
          toastId: "info1",
        });
        setTimeout(() => {
          setOpenModal(false);
        }, 3000);
      })
      .catch(async (err) => {
        toast.error("Selected Category cannot be deleted.", {
          theme: "colored",
          hideProgressBar: true,
          autoClose: 1500,
          position: "bottom-right",
          toastId: "info1",
        });
        setTimeout(() => {
          setOpenModal(false);
        }, 3000);
      });
  }

  // add new category function ----{start
  function addCategory() {
    setOpenModal(true);
    // setEditState(!editState);
    setModalTitle("Are you sure You want to delete?");

    HTTPMethods.postMenu("category/addcategory", {}).then(async (res: any) =>
      alert(res)
    );
  }

  useEffect(() => {
    setCategory(
      category.map((cat: any, index: number) => {
        if (parseInt(id) === index) {
          cat.active = true;
        } else cat.active = false;
        return cat;
      })
    );
  }, [id]);

  useEffect(() => {
    if (openModal && deleteItem) {
      handleDelete(deleteCategoryId);
      setDeleteItem(false);
    }
  }, [openModal, deleteItem]);
  return (
    <>
      <MenuCategoryMainDIv {...rest}>
        <MenuTitleName>Categories</MenuTitleName>

        {category.map((item, idx) => (
          <MenuCategoriesDiv
            clicked={item.active}
            onClick={() => {
              navigate(`/menu/${idx}`);
              setDrawerSubCatId(item.category_id);
            }}
            onMouseEnter={() => setHoveredIndex(idx)}
            onMouseLeave={() => setHoveredIndex(null)}>
            <CategoryTitle key={idx}>{item.category_name}</CategoryTitle>
            {hoveredIndex === idx || item.active ? (
              <EditCategory>
                <Icon
                  onClick={() => {
                    setAddMenuModal(!addMenuModal);
                    setModalTitle("Edit Category");
                    setDeleteCategoryId(item.category_id);
                    handleEdit;
                  }}>
                  {editIcon}
                </Icon>
                <Icon
                  onClick={() => {
                    setOpenModal(true);

                    setDeleteCategoryId(item.category_id);
                  }}>
                  {deleteIcon}
                </Icon>
              </EditCategory>
            ) : (
              <></>
            )}
          </MenuCategoriesDiv>
        ))}

        <ActionButton
          icon={<MdAdd size={25} />}
          label={"add category"}
          onClick={() => {
            addCategory;
            setAddMenuModal(true);
            setModalTitle("Add New Category");
          }}
          forMenuCat={true}
        />
      </MenuCategoryMainDIv>
      {openModal === true ? (
        <AlertDeleteModal
          title={"Are you sure you want to delete?"}
          setOpenModal={setOpenModal}
          setDeleteItem={setDeleteItem}
          deleteItem={deleteItem}
        />
      ) : addMenuModal === true ? (
        <AddNewMenuModal
          title={modalTitle}
          setAddMenuModal={setAddMenuModal}
          footerButtons={<></>}>
          <form onSubmit={handleSubmit}>
            <TextField
              type="text"
              label="category name"
              name="category_name"
              placeholder="Category Name"
              onChange={handleChange}
              error={
                touched.category_name && errors.category_name
                  ? errors.category_name
                  : null
              }
            />
            <label htmlFor="image">
              <img src={file || "/assets/imageUpload.svg"} alt="" />
              <TextField
                type="file"
                label="Category Image"
                name="image"
                // @ts-ignore
                id="image"
                error={touched.image && errors.image ? errors.image : null}
                onChange={handleChange}
              />
            </label>
            <Button
              onClick={() => {
                resetForm();
              }}
              type="reset">
              Clear
            </Button>
            <Button
              onClick={(e) => {
                e.preventDefault();
                handleSubmit();
              }}
              type="submit">
              Add
            </Button>
          </form>
        </AddNewMenuModal>
      ) : (
        <></>
      )}
    </>
  );
};

export default MenuCategories;
